{% if user_role == 0 %}
    {% extends 'admin_layout.html' %}
{% elif user_role == 1 %}
    {% extends 'customer_layout.html' %}
{% else %}
    {% extends 'service_provider_layout.html' %}
{% endif %}

{% block name %}
    Service Provider Dashboard
{% endblock %}
{% block content %}
{% include 'flashmessage.html' %}

<div class="container" style="height: fit-content;">
    <h1>Professional Dashboard</h1><hr>        
    <div>
        <h3 style="margin-top: 50px;"><b>Requested Service Requests</b></h3>
        {% if requested_service_requests %}
        <table class="table table-bordered table-hover">
            <thead class="table-success">
              <tr>
                    <th style="text-align: center; vertical-align:middle">Sequence Number</th>
                    <th style="text-align: center; vertical-align:middle">Service Request Id</th>
                    <th style="text-align: center; vertical-align:middle">Customer Name</th>
                    <th style="text-align: center; vertical-align:middle">Service Request Date and Time</th>
                    <th style="text-align: center; vertical-align:middle">Service City, Pincode</th>
                    <th style="text-align: center; vertical-align:middle">Service Status</th>
                    <th style="text-align: center; vertical-align:middle">Action</th>
                </tr>
            </thead>
            <tbody>
                {% set count = namespace(value=1) %}
                {% for service_request in requested_service_requests %}
                <tr>
                    <td style="text-align: center; vertical-align:middle">{{ count.value }}</td>
                    <td style="text-align: center; vertical-align:middle">{{ service_request.sr_id }}</td>
                    <td style="text-align: center; vertical-align:middle">{{ service_request.sr_customer_name }}</td>
                    <td style="text-align: center; vertical-align:middle">{{ service_request.sr_date_time }}</td>
                    <td style="text-align: center; vertical-align:middle">{{ service_request.sr_city }}, {{ service_request.sr_pincode }}</td>
                    <td style="text-align: center; vertical-align:middle">{{ service_request.sr_status }}</td>
                    <td style="text-align: center; vertical-align:middle">
                        {% if service_provider.p_blocked == True %}
                                <a href="{{ url_for('main.accept_request', sr_id=service_request.sr_id) }}" class="btn btn-outline-secondary"><i class="bi bi-check-lg"></i> Accept</a>
                                <a href="{{ url_for('main.reject_request', sr_id=service_request.sr_id) }}" class="btn btn-outline-secondary"><i class="bi bi-x-lg"></i> Reject</a>
                        {% else %}
                                <a href="{{ url_for('main.accept_request', sr_id=service_request.sr_id) }}" class="btn btn-outline-success"><i class="bi bi-check-lg"></i> Accept</a>
                                <a href="{{ url_for('main.reject_request', sr_id=service_request.sr_id) }}" class="btn btn-outline-danger"><i class="bi bi-x-lg"></i> Reject</a>
                        {% endif %}
                    </td>
                    {% set count.value = count.value + 1 %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
            <hr>
            <h4>No Service Requests Currently</h4>
        {% endif %}

        <h3 style="margin-top: 50px;"><b>Assigned Service Requests</b></h3>
        {% if assigned_service_requests %}
        <table class="table table-bordered table-hover">
            <thead class="table-success">
              <tr>
                    <th style="text-align: center; vertical-align:middle">Sequence Number</th>
                    <th style="text-align: center; vertical-align:middle">Service Request Id</th>
                    <th style="text-align: center; vertical-align:middle">Customer Name</th>
                    <th style="text-align: center; vertical-align:middle">Service Request Date and Time</th>
                    <th style="text-align: center; vertical-align:middle">Service City, Pincode</th>
                    <th style="text-align: center; vertical-align:middle">Service Status</th>
                    <th style="text-align: center; vertical-align:middle">Action</th>
                </tr>
            </thead>
            <tbody>
                {% set count = namespace(value=1) %}
                {% for service_request in assigned_service_requests %}
                <tr>
                    <td style="text-align: center; vertical-align:middle">{{ count.value }}</td>
                    <td style="text-align: center; vertical-align:middle">{{ service_request.sr_id }}</td>
                    <td style="text-align: center; vertical-align:middle">{{ service_request.sr_customer_name }}</td>
                    <td style="text-align: center; vertical-align:middle">{{ service_request.sr_date_time }}</td>
                    <td style="text-align: center; vertical-align:middle">{{ service_request.sr_city }}, {{ service_request.sr_pincode }}</td>
                    <td style="text-align: center; vertical-align:middle">{{ service_request.sr_status }}</td>
                    <td style="text-align: center; vertical-align:middle">
                        <a href="{{ url_for('main.service_request_details', sr_id = service_request.sr_id) }}" class="btn btn-outline-primary"><i class="bi bi-eye-fill"></i> View</a>
                        {% if service_provider.p_blocked == True %}
                                <a href="{{ url_for('main.reject_request', sr_id=service_request.sr_id) }}" class="btn btn-outline-secondary"><i class="bi bi-x-lg"></i> Reject</a>
                        {% else %}
                                <a href="{{ url_for('main.reject_request', sr_id=service_request.sr_id) }}" class="btn btn-outline-danger"><i class="bi bi-x-lg"></i> Reject</a>
                        {% endif %}
                    </td>
                    {% set count.value = count.value + 1 %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
            <hr>
            <h4>No Assigned Service Requests Currently</h4>
        {% endif %}


        <h3 style="margin-top: 50px;"><b>Closed Services</b></h3>
        {% if closed_service_requests %}
        <table class="table table-bordered table-hover">
            <thead class="table-success">
              <tr>
                    <th style="text-align: center; vertical-align:middle">Sequence Number</th>
                    <th style="text-align: center; vertical-align:middle">Service Request Id</th>
                    <th style="text-align: center; vertical-align:middle">Customer Name</th>
                    <th style="text-align: center; vertical-align:middle">Service Date and Time</th>
                    <th style="text-align: center; vertical-align:middle">Service City, Pincode</th>
                    <th style="text-align: center; vertical-align:middle">Service Feedback</th>
                    <th style="text-align: center; vertical-align:middle">Service Rating</th>
                    <th style="text-align: center; vertical-align:middle">Action</th>
                </tr>
            </thead>
            <tbody>
                {% set count = namespace(value=0) %}
                {% for service_request in closed_service_requests %}
                <tr>

                <td style="text-align: center; vertical-align:middle">{{ count.value+1 }}</td>
                <td style="text-align: center; vertical-align:middle">{{ service_request.sr_id }}</td>
                <td style="text-align: center; vertical-align:middle">{{ service_request.sr_customer_name }}</td>
                <td style="text-align: center; vertical-align:middle">{{ service_request.sr_date_time.strftime('%d %b %Y %I:%M %p') }}</td>
                <td style="text-align: center; vertical-align:middle">{{ service_request.sr_city }}, {{ service_request.sr_pincode }}</td>
                <td style="text-align: center; vertical-align:middle">
                {% for closed_feedback in closed_feedbacks %}
                    {% if closed_feedback.sf_service_request_id == service_request.sr_id %}
                        {{ closed_feedback.sf_feedback }}
                    {% endif %}
                {% endfor %}
                </td>
                <td style="text-align: center; vertical-align:middle">
                {% for closed_feedback in closed_feedbacks %}
                    {% if closed_feedback.sf_service_request_id == service_request.sr_id %}
                        {{ closed_feedback.sf_rating }}</td>
                    {% endif %}
                {% endfor %}
                </td>
                <td style="text-align: center; vertical-align:middle">
                    <a href="{{ url_for('main.service_request_details', sr_id = service_request.sr_id) }}" class="btn btn-outline-primary"><i class="bi bi-eye-fill"></i> View</a>
                </td>
                {% set count.value = count.value + 1 %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <hr>
        <h4>No Closed Service Requests Currently</h4>
        {% endif %}
        <h3 style="margin-top: 50px; height:fit-content"><b>Rejected Services</b></h3>
        {% if rejected_service_requests %}
        <table class="table table-bordered table-hover">
            <thead class="table-success">
              <tr>
                    <th style="text-align: center; vertical-align:middle">Sequence Number</th>
                    <th style="text-align: center; vertical-align:middle">Service Request Id</th>
                    <th style="text-align: center; vertical-align:middle">Customer Name</th>
                    <th style="text-align: center; vertical-align:middle">Service Date and Time</th>
                    <th style="text-align: center; vertical-align:middle">Service City, Pincode</th>
                    <th style="text-align: center; vertical-align:middle">Rejection Reason</th>
                    <th style="text-align: center; vertical-align:middle">Action</th>
                </tr>
            </thead>
            <tbody>
                {% set count = namespace(value=1) %}
                {% for service_request in rejected_service_requests %}
                <tr>
                {% if service_request.sr_status == "Rejected" %}
                <td style="text-align: center; vertical-align:middle">{{ count.value }}</td>
                <td style="text-align: center; vertical-align:middle">{{ service_request.sr_id }}</td>
                <td style="text-align: center; vertical-align:middle">{{ service_request.sr_customer_name }}</td>
                <td style="text-align: center; vertical-align:middle">{{ service_request.sr_date_time }}</td>
                <td style="text-align: center; vertical-align:middle">{{ service_request.sr_city }}, {{ service_request.sr_pincode }}</td>
                <td style="text-align: center; vertical-align:middle">
                {% for rejected_feedback in rejected_feedbacks %}
                    {% if rejected_feedback.sf_service_request_id == service_request.sr_id %}
                        {{ rejected_feedback.sf_feedback }}
                    {% endif %}
                {% endfor %}
                </td>
                <td style="text-align: center; vertical-align:middle">
                    <a href="{{ url_for('main.service_request_details', sr_id = service_request.sr_id) }}" class="btn btn-outline-primary"><i class="bi bi-eye-fill"></i> View</a>
                </td>
                {% set count.value = count.value + 1 %}
                {% endif %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <hr>
        <h4>No Rejected Service Requests Currently</h4>
        {% endif %}
    </div>
</div>


{% endblock %}